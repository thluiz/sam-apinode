/*
Deployment script for sam

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "sam"
:setvar DefaultFilePrefix "sam"
:setvar DefaultDataPath ""
:setvar DefaultLogPath ""

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
IF EXISTS (SELECT 1
           FROM   [sys].[databases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET QUERY_STORE (CLEANUP_POLICY = (STALE_QUERY_THRESHOLD_DAYS = 30), MAX_STORAGE_SIZE_MB = 100) 
            WITH ROLLBACK IMMEDIATE;
    END


GO
PRINT N'Altering [dbo].[UpdatePersonData]...';


GO
ALTER procedure [dbo].[UpdatePersonData](                
 @id int,                
 @name varchar(200),                
 @birth_date date,                
 @admission_date date,                
 @enrollment_date date,                
 @baaisi_date date,                
 @kf_name varchar(200),  
 @identification varchar(50),  
 @identification2 varchar(50),  
 @passport varchar(50),  
 @passport_expiration_date date,  
 @occupation varchar(100),  
 @kf_name_ideograms NVarchar(200),              
 @family_id int,            
 @branch_id int,            
 @program_id int,            
 @domain_id int,
 @destiny_family_id int
) as                
begin                 
 if(@kf_name is not null)                
 begin                
  delete from person_alias where person_id = @id and kungfu_name = 1                      
                
  insert into person_alias(person_id, alias, kungfu_name, ideograms)                      
   values(@id, @kf_name, 1, @kf_name_ideograms)                      
 end                
                
 update person set [name] = @name,                
  birth_date = @birth_date,          
  admission_date = @admission_date,                
  baaisi_date = @baaisi_date,          
  family_id = @family_id, branch_id = @branch_id,             
  program_id = @program_id, domain_id = @domain_id,    
  enrollment_date = @enrollment_date,  
  identification = @identification,   
  identification2 = @identification2,   
  occupation = @occupation,  
  passport = @passport,  
  passport_expiration_date = @passport_expiration_date,
  destiny_family_id = @destiny_family_id
 where id = @id              
         
 exec CheckPeopleStatus @id        
      
 exec GetPersonData @id      
                 
end
GO
PRINT N'Update complete.';


GO
